const config={simulateMobileTap:!1,mobileTapRotateAmount:1,blobFresnelColour:16727846,blobFresnelAmount1:.82,blobFresnelAmount2:1.84,blobFresnelAmount3:.69,blobFresnelAmount4:2,blobFresnelAmount5:0,blobFresnelAmount6:0,blobFresnelAmount7:0,blobFresnelAmount8:0,initialFov:97,cameraDist:3.8,selectedDist:.6,showLightHelpers:!1,restrictMobile:!1,infiniteFloorSize:2e4},hasHover=window.matchMedia("(hover: hover)").matches,renderer=new THREE.WebGLRenderer({alpha:!0,canvas:document.getElementById("threeCanvas")});renderer.setPixelRatio(1*window.devicePixelRatio),renderer.setSize(window.innerWidth,window.innerHeight),renderer.setClearColor(16777215,0);const camera=new THREE.PerspectiveCamera(config.initialFov,window.innerWidth/window.innerHeight,.01,2e4);camera.position.z=Math.sqrt(config.cameraDist*config.cameraDist/2),camera.position.y=Math.sqrt(config.cameraDist*config.cameraDist/2),camera.lookAt(0,0,0);const group=new THREE.Object3D,objects=[],clickables=[],blobs=[],scene=new THREE.Scene;scene.add(group);let controls=new THREE.ObjectControls(group,renderer.domElement,hasHover,config.restrictMobile);scene.fog=new THREE.FogExp2(0,.05);const directionalLight1=new THREE.DirectionalLight(16777215,.2),directionalLight2=new THREE.DirectionalLight(16777215,.1),directionalLight3=new THREE.DirectionalLight(16777215,1),directionalLight4=new THREE.DirectionalLight(16777215,1);var directionalLightHelper1,directionalLightHelper2,directionalLightHelper3,directionalLightHelper4,blobMaterial=fresnelMaterial(config.blobFresnelColour,config.blobFresnelAmount1,config.blobFresnelAmount2,config.blobFresnelAmount3,config.blobFresnelAmount4,config.blobFresnelAmount5,config.blobFresnelAmount6,config.blobFresnelAmount7,config.blobFresnelAmount8);const hemiLight=new THREE.HemisphereLight(16777215,0,.8),objLoader=new THREE.OBJLoader,fbxLoader=new THREE.FBXLoader,textureLoader=new THREE.TextureLoader;var video,videoTexture,videoMaterial,videoObj;const mouse=new THREE.Vector2(-100,-100),raycaster=new THREE.Raycaster;var selectedObj,hoverObj,hoverObjPosition0=new THREE.Vector3;const gui=new dat.GUI({autoPlace:!0}),cameraGUI=gui.addFolder("Camera"),controlsGUI=gui.addFolder("Controls"),colourGUI=gui.addFolder("Colour"),lightsGUI=gui.addFolder("Lights");let infiniteFloorMaterial;var clickBusy=!1;const clock=new THREE.Clock;function initLightHelpers(){directionalLightHelper1=new THREE.DirectionalLightHelper(directionalLight1,1,"purple"),directionalLightHelper2=new THREE.DirectionalLightHelper(directionalLight2,1,"blue"),directionalLightHelper3=new THREE.DirectionalLightHelper(directionalLight3,1,"red"),directionalLightHelper4=new THREE.DirectionalLightHelper(directionalLight4,1,"green"),scene.add(directionalLightHelper1),scene.add(directionalLightHelper2),scene.add(directionalLightHelper3),scene.add(directionalLightHelper4),config.showLightHelpers=!0}function disposeLightHelpers(){directionalLightHelper1&&(directionalLightHelper1.dispose(),scene.remove(directionalLightHelper1)),directionalLightHelper2&&(directionalLightHelper2.dispose(),scene.remove(directionalLightHelper2)),directionalLightHelper3&&(directionalLightHelper3.dispose(),scene.remove(directionalLightHelper3)),directionalLightHelper4&&(directionalLightHelper4.dispose(),scene.remove(directionalLightHelper4)),config.showLightHelpers=!1}function initLights(){directionalLight1.position.set(0,2.5,3.9),directionalLight2.position.set(4,1,-4),directionalLight3.position.set(-4,1,-4),directionalLight4.position.set(0,-4,0),scene.add(directionalLight1),scene.add(directionalLight2),scene.add(directionalLight3),scene.add(directionalLight4)}function initInfiniteFloor(){const e=textureLoader.load("/sda/assets/images/tiles.png");e.anisotrophy=2,e.minFilter=THREE.LinearFilter,e.wrapS=THREE.RepeatWrapping,e.wrapT=THREE.RepeatWrapping,e.repeat=new THREE.Vector2(config.infiniteFloorSize,config.infiniteFloorSize),infiniteFloorMaterial=new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide,opacity:0,transparent:!0});const o=new THREE.PlaneGeometry(config.infiniteFloorSize,config.infiniteFloorSize);o.rotateX(Math.PI/2),o.translate(0,-2.01,0);const n=new THREE.Mesh(o,infiniteFloorMaterial);n.name="infiniteFloor",scene.add(n),group.add(n),objects.push(n)}function initFloor(){const e=textureLoader.load("/sda/assets/images/tiles.png");e.anisotrophy=8,e.minFilter=THREE.LinearFilter,e.wrapS=THREE.RepeatWrapping,e.wrapT=THREE.RepeatWrapping,e.repeat=new THREE.Vector2(6,6);const o=new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide}),n=new THREE.PlaneGeometry(6,6);n.rotateX(Math.PI/2),n.translate(0,-2,0);const t=new THREE.Mesh(n,o);scene.add(t),group.add(t),objects.push(t),initInfiniteFloor()}function onResize(){console.log("resizing"),camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight)}function onMouseMove(e){mouse.x=e.clientX/window.innerWidth*2-1,mouse.y=-e.clientY/window.innerHeight*2+1}function applyFadeToAllExcept(e){document.getElementById("canvasBg").classList.add("faded");for(let o of objects)if(o!==e&&"infiniteFloor"!==o.name)if(Array.isArray(o.material))for(let e of o.material){if(new TWEEN.Tween(e).to({opacity:.7},500).easing(TWEEN.Easing.Quadratic.InOut).start(),e.map){new TWEEN.Tween(e.color).to({r:.7,g:.7,b:.7},500).easing(TWEEN.Easing.Quadratic.InOut).start()}}else if("blob"==o.name){const e={v:1},n=new THREE.Color(config.blobFresnelColour);new TWEEN.Tween(e).to({v:3},500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate((()=>{const t=new THREE.Color(config.blobFresnelColour);t.g=n.g*e.v,t.b=n.g*e.v,console.log(t.getHexString()),blobMaterial=fresnelMaterial(t.getHex(),config.blobFresnelAmount1,config.blobFresnelAmount2,config.blobFresnelAmount3,config.blobFresnelAmount4,config.blobFresnelAmount5,config.blobFresnelAmount6,config.blobFresnelAmount7,config.blobFresnelAmount8),o.material=blobMaterial})).start()}else{new TWEEN.Tween(o.material).to({opacity:.5},500).easing(TWEEN.Easing.Quadratic.InOut).start()}}function removeFadeFromAll(){document.getElementById("canvasBg").classList.remove("faded");for(let e of objects)if("infiniteFloor"!==e.name)if(Array.isArray(e.material))for(let o of e.material){if(new TWEEN.Tween(o).to({opacity:1},500).easing(TWEEN.Easing.Quadratic.InOut).start(),o.map){new TWEEN.Tween(o.color).to({r:1,g:1,b:1},500).easing(TWEEN.Easing.Quadratic.InOut).start()}}else if("blob"==e.name){const o={v:3},n=new THREE.Color(config.blobFresnelColour);new TWEEN.Tween(o).to({v:1},500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate((()=>{const t=new THREE.Color(config.blobFresnelColour);t.g=n.g*o.v,t.b=n.g*o.v,console.log(t.getHex()),blobMaterial=fresnelMaterial(t.getHex(),config.blobFresnelAmount1,config.blobFresnelAmount2,config.blobFresnelAmount3,config.blobFresnelAmount4,config.blobFresnelAmount5,config.blobFresnelAmount6,config.blobFresnelAmount7,config.blobFresnelAmount8),e.material=blobMaterial})).start()}else{new TWEEN.Tween(e.material).to({opacity:1},500).easing(TWEEN.Easing.Quadratic.InOut).start()}}function handleImgClicked(e){selectedObj=e,scene.attach(e),e.selected=!0,selectedObj.bringToFocus(camera,config.selectedDist),applyFadeToAllExcept(selectedObj)}function putSelectedBack(){group.attach(selectedObj),selectedObj.putSelectedBack(700),removeFadeFromAll(),selectedObj=null}function handleClick(){if(!clickBusy)if(setTimeout((function(){clickBusy=!1}),200),clickBusy=!0,selectedObj)putSelectedBack();else if(clickables.length>0){const e=raycaster.intersectObjects(clickables);e.length>0&&handleImgClicked(e[0].object)}}function handleAnimate(){videoTexture&&videoTexture.update(),controls.update(clock.getDelta()),selectedObj&&animateSelectedObj()}function animateSelectedObj(){selectedObj.position.y+=.001*Math.sin(clock.getElapsedTime()),selectedObj.rotation.x+=2e-4*Math.sin(1.2*clock.getElapsedTime()),selectedObj.rotation.y+=5e-4*Math.sin(.7*clock.getElapsedTime())}function handleRaycast(){if(raycaster.setFromCamera(mouse,camera),!this.selectedObj&&clickables.length>0){const e=raycaster.intersectObjects(clickables);if(e.length>0){renderer.domElement.style.cursor="pointer",controls.mouseBusy=!0;for(let o of clickables)e[0].object!=o||o.tweening||o.selected?(o.hovered=!1,!o.up||o.tweening||o.selected||o.putBack()):(o.hovered=!0,o.liftUp())}else{controls.mouseBusy=!1,renderer.domElement.style.cursor="grab";for(let e of clickables)e.hovered=!1,!e.up||e.tweening||e.selected||e.putBack()}}}function showInfiniteFloor(){new TWEEN.Tween(infiniteFloorMaterial).to({opacity:.11},200).easing(TWEEN.Easing.Quadratic.InOut).start()}function hideInfiniteFloor(){new TWEEN.Tween(infiniteFloorMaterial).to({opacity:0},200).easing(TWEEN.Easing.Quadratic.InOut).start()}function render(){handleAnimate(),renderer.render(scene,camera),TWEEN.update(),requestAnimationFrame(render),hasHover&&handleRaycast()}function handleTouchStart(){giveUsASpin()}function addEvents(){window.addEventListener("resize",onResize,!1),hasHover||!config.restrictMobile?(renderer.domElement.addEventListener("mousemove",onMouseMove,!1),renderer.domElement.addEventListener("mousedown",handleClick,!1)):renderer.domElement.addEventListener("touchstart",handleTouchStart,!1)}function configLoadingManager(){THREE.DefaultLoadingManager.onStart=function(e,o,n){console.log("Started loading file: "+e+".\nLoaded "+o+" of "+n+" files.")},THREE.DefaultLoadingManager.onLoad=function(){console.log("Loading Complete!"),document.getElementById("threeCanvas").style.opacity=1;let e=document.getElementById("loader");e.style.opacity=0,spinIn(),setTimeout((function(){e.remove()}),2e3)},THREE.DefaultLoadingManager.onProgress=function(e,o,n){console.log("Loading file: "+e+".\nLoaded "+o+" of "+n+" files.")},THREE.DefaultLoadingManager.onError=function(e){console.log("There was an error loading "+e)}}function addObj(e,o){objLoader.load(e,(function(e){e.traverse((function(e){e instanceof THREE.Mesh&&o(e)}))}),(function(e){}),(function(e){console.log(e)}))}function addFbx(e,o){fbxLoader.load(e,(function(e){e.traverse((function(e){e instanceof THREE.Mesh&&o(e)}))}),(function(e){}),(function(e){console.log(e)}))}function addImage(e,o){try{const n=new THREE.MeshBasicMaterial({transparent:!1}),t=textureLoader.load(e);t.anisotrophy=4,n.map=t;const i=new THREE.MeshBasicMaterial({color:0,transparent:!0,opacity:0}),a=[i,i,i,i,n,n],r=new Image;r.onload=()=>{const e=r.height/r.width,n=new THREE.BoxGeometry(1,1*e,1e-4),t=new ImageMesh(n,a);o(t)},r.src=e}catch(e){console.log(e)}}function giveUsASpin(){const e=new TWEEN.Tween(controls).to({autoSpeed:3*config.mobileTapRotateAmount},100).easing(TWEEN.Easing.Quadratic.In).onComplete((()=>{o.start()})),o=new TWEEN.Tween(controls).to({autoSpeed:.1},2e3*config.mobileTapRotateAmount).easing(TWEEN.Easing.Quadratic.Out).onComplete((()=>{}));e.start()}function spinIn(){const e=new TWEEN.Tween(controls).to({autoSpeed:15},100).easing(TWEEN.Easing.Quadratic.In).onComplete((()=>{o.start()})),o=new TWEEN.Tween(controls).to({autoSpeed:.1},2e3).easing(TWEEN.Easing.Quadratic.Out).onComplete((()=>{}));e.start();new TWEEN.Tween(group.scale).to({x:1,y:1,z:1},2e3).easing(TWEEN.Easing.Quadratic.Out).onComplete((()=>{})).start(),e.start()}function handleBlobColourChange(){for(let e of blobs)blobMaterial=fresnelMaterial(config.blobFresnelColour,config.blobFresnelAmount1,config.blobFresnelAmount2,config.blobFresnelAmount3,config.blobFresnelAmount4,config.blobFresnelAmount5,config.blobFresnelAmount6,config.blobFresnelAmount7,config.blobFresnelAmount8),e.material=blobMaterial}function handleUpdateCameraMatrix(){camera.updateProjectionMatrix()}function handleUpdateCameraDist(){camera.position.z=Math.sqrt(config.cameraDist*config.cameraDist/2),camera.position.y=Math.sqrt(config.cameraDist*config.cameraDist/2),camera.lookAt(0,0,0),handleUpdateCameraMatrix()}function handleSelectedDistUpdate(){selectedObj&&(selectedObj.position.y=camera.position.y-config.selectedDist,selectedObj.position.z=camera.position.z-config.selectedDist)}function handleToggleLightHelpers(){config.showLightHelpers?initLightHelpers():disposeLightHelpers()}function handleControlsChange(){console.log(config.restrictMobile),controls=new THREE.ObjectControls(group,renderer.domElement,hasHover,config.restrictMobile)}function initGUI(){controlsGUI.add(controls,"autoSpeed",-1,1,.05).name("Auto Rotate Speed"),controlsGUI.add(controls,"rotationSpeed",0,.1,.01).name("Drag Rotate Speed"),controlsGUI.add(config,"mobileTapRotateAmount",0,3,.1).name("Mobile Tap Speed"),controlsGUI.add(config,"restrictMobile").name("Restrict Mobile Controls").onChange(handleControlsChange),viewContraintsGUI=controlsGUI.addFolder("View Angle Contraints"),viewContraintsGUI.add(controls.maxRotationAngles.x,"from",Math.PI/4,Math.PI,.01).name("Min Angle"),viewContraintsGUI.add(controls.maxRotationAngles.x,"to",0,Math.PI,.01).name("Max Angle"),controlsGUI.add(config,"simulateMobileTap").onChange(giveUsASpin).name("Simulate Mobile Tap"),colourGUI.addColor(config,"blobFresnelColour").onChange(handleBlobColourChange).name("Fresnel Colour"),colourGUI.add(config,"blobFresnelAmount1",0,2,.01).onChange(handleBlobColourChange).name("Fresel Mod 1"),colourGUI.add(config,"blobFresnelAmount2",0,2,.01).onChange(handleBlobColourChange).name("Fresel Mod 2"),colourGUI.add(config,"blobFresnelAmount3",0,2,.01).onChange(handleBlobColourChange).name("Fresel Mod 3"),colourGUI.add(config,"blobFresnelAmount4",0,2,.01).onChange(handleBlobColourChange).name("Fresel Mod 4"),colourGUI.add(config,"blobFresnelAmount5",0,2,.01).onChange(handleBlobColourChange).name("Fresel Mod 5"),colourGUI.add(config,"blobFresnelAmount6",0,2,.01).onChange(handleBlobColourChange).name("Fresel Mod 6"),colourGUI.add(config,"blobFresnelAmount7",0,2,.01).onChange(handleBlobColourChange).name("Fresel Mod 7"),colourGUI.add(config,"blobFresnelAmount8",0,2,.01).onChange(handleBlobColourChange).name("Fresel Mod 8"),colourGUI.add(infiniteFloorMaterial,"opacity",0,1,.01).name("Infinite Floor Opacity"),cameraGUI.add(camera,"fov",0,150,1).onChange(handleUpdateCameraMatrix).name("FOV"),cameraGUI.add(config,"cameraDist",1,20,.1).onChange(handleUpdateCameraDist).name("Camera Dist"),cameraGUI.add(config,"selectedDist",0,5,.1).onChange(handleSelectedDistUpdate).name("Selected Obj Dist"),lightsGUI.add(config,"showLightHelpers").onChange(handleToggleLightHelpers).name("Show Light Helpers"),directionalLight1GUI=lightsGUI.addFolder("Directional Light 1"),directionalLight1GUI.add(directionalLight1,"intensity",0,1,.1).name("Intensity"),directionalLight1GUI.add(directionalLight1.position,"x",-3,3,.1).name("X position"),directionalLight1GUI.add(directionalLight1.position,"y",0,8,.1).name("Y position"),directionalLight1GUI.add(directionalLight1.position,"z",0,10,.1).name("Z position"),directionalLight2GUI=lightsGUI.addFolder("Directional Light 2"),directionalLight2GUI.add(directionalLight2,"intensity",0,1,.1).name("Intensity"),directionalLight2GUI.add(directionalLight2.position,"x",0,8,.1).name("X position"),directionalLight2GUI.add(directionalLight2.position,"y",0,8,.1).name("Y position"),directionalLight2GUI.add(directionalLight2.position,"z",-10,0,.1).name("Z position"),directionalLight3GUI=lightsGUI.addFolder("Directional Light 3"),directionalLight3GUI.add(directionalLight3,"intensity",0,1,.1),directionalLight3GUI.add(directionalLight3.position,"x",-8,0,.1),directionalLight3GUI.add(directionalLight3.position,"y",0,8,.1),directionalLight3GUI.add(directionalLight3.position,"z",-10,0,.1),directionalLight4GUI=lightsGUI.addFolder("Directional Light 4"),directionalLight4GUI.add(directionalLight4,"intensity",0,1,.1),directionalLight4GUI.add(directionalLight4.position,"x",-8,0,.1),directionalLight4GUI.add(directionalLight4.position,"y",0,8,.1),directionalLight4GUI.add(directionalLight4.position,"z",-10,0,.1)}function initRoomFromConfig(){for(let e of roomConfig.images)addImage(e.path,(function(o){o.scale.set(e.scale,e.scale,e.scale),o.position.set(e.position.x,e.position.y,e.position.z),o.rotation.set(e.rotation.x,e.rotation.y,e.rotation.z),o.position0.copy(o.position),o.rotation0.copy(o.rotation),o.quaternion0.copy(o.quaternion),o.scale0.copy(o.scale),group.add(o),objects.push(o),clickables.push(o)}));for(let e of roomConfig.blobs)addFbx(e.path,(function(o){o.material=blobMaterial,o.scale.set(e.scale,e.scale,e.scale),o.position.set(e.position.x,e.position.y,e.position.z),o.rotation.set(e.rotation.x,e.rotation.y,e.rotation.z),group.add(o),o.name="blob",objects.push(o),blobs.push(o)}))}function initGroup(){group.scale.set(.05,.05,.05)}function initMinimap(){let e=document.getElementById("minimap");e.addEventListener("mouseenter",showInfiniteFloor),e.addEventListener("mouseleave",hideInfiniteFloor)}function init(){initGroup(),initLights(),initFloor(),initRoomFromConfig(),addEvents(),initGUI(),configLoadingManager(),render()}init();