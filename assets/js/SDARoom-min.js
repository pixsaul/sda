const config={simulateMobileTap:!1,mobileTapRotateAmount:1,blobFresnelColour:16727846,blobFresnelAmount1:.1,blobFresnelAmount2:1.18,blobFresnelAmount3:.32,blobFresnelAmount4:.28,blobFresnelAmount5:0,blobFresnelAmount6:0,blobFresnelAmount7:0,blobFresnelAmount8:0,initialFov:97,cameraDist:8.8,selectedDist:.127,selectedScale:.163,showLightHelpers:!1,restrictMobile:!1,infiniteFloorSize:100},hasHover=window.matchMedia("(hover: hover)").matches,renderer=new THREE.WebGLRenderer({alpha:!0,canvas:document.getElementById("threeCanvas")}),canvas=renderer.domElement,cWidth=canvas.clientWidth,cHeight=canvas.clientHeight;renderer.setPixelRatio(1*window.devicePixelRatio),canvas.width===cWidth&&canvas.height===cHeight||renderer.setSize(cWidth,cHeight,!1),renderer.setClearColor(16777215,0);const camera=new THREE.PerspectiveCamera(config.initialFov,cWidth/cHeight,.001,2e4);camera.position.z=Math.sqrt(config.cameraDist*config.cameraDist/2),camera.position.y=Math.sqrt(config.cameraDist*config.cameraDist/2),camera.lookAt(0,0,0);const group=new THREE.Object3D,objects=[],clickables=[],blobs=[],scene=new THREE.Scene;scene.add(group);let controls=new THREE.ObjectControls(group,renderer.domElement,hasHover,config.restrictMobile);const directionalLight1=new THREE.DirectionalLight(16777215,0),directionalLight2=new THREE.DirectionalLight(16777215,.3),directionalLight3=new THREE.DirectionalLight(16777215,.4),directionalLight4=new THREE.DirectionalLight(16777215,.5);var directionalLightHelper1,directionalLightHelper2,directionalLightHelper3,directionalLightHelper4,blobMaterial=fresnelMaterial(config.blobFresnelColour,config.blobFresnelAmount1,config.blobFresnelAmount2,config.blobFresnelAmount3,config.blobFresnelAmount4,config.blobFresnelAmount5,config.blobFresnelAmount6,config.blobFresnelAmount7,config.blobFresnelAmount8);const hemiLight=new THREE.HemisphereLight(16777215,0,.8),objLoader=new THREE.OBJLoader,fbxLoader=new THREE.FBXLoader,textureLoader=new THREE.TextureLoader;var videoTexture,videoMaterial,videoObj,videos=[];const mouse=new THREE.Vector2(-100,-100),raycaster=new THREE.Raycaster;var selectedObj,hoverObj,hoverObjPosition0=new THREE.Vector3;const gui=new dat.GUI({autoPlace:!0}),cameraGUI=gui.addFolder("Camera"),controlsGUI=gui.addFolder("Controls"),colourGUI=gui.addFolder("Colour"),lightsGUI=gui.addFolder("Lights");let infiniteFloorMaterial;var clickBusy=!1;const clock=new THREE.Clock;let fadePlaneMesh;function initLightHelpers(){directionalLightHelper1=new THREE.DirectionalLightHelper(directionalLight1,1,"purple"),directionalLightHelper2=new THREE.DirectionalLightHelper(directionalLight2,1,"blue"),directionalLightHelper3=new THREE.DirectionalLightHelper(directionalLight3,1,"red"),directionalLightHelper4=new THREE.DirectionalLightHelper(directionalLight4,1,"green"),scene.add(directionalLightHelper1),scene.add(directionalLightHelper2),scene.add(directionalLightHelper3),scene.add(directionalLightHelper4),config.showLightHelpers=!0}function disposeLightHelpers(){directionalLightHelper1&&(directionalLightHelper1.dispose(),scene.remove(directionalLightHelper1)),directionalLightHelper2&&(directionalLightHelper2.dispose(),scene.remove(directionalLightHelper2)),directionalLightHelper3&&(directionalLightHelper3.dispose(),scene.remove(directionalLightHelper3)),directionalLightHelper4&&(directionalLightHelper4.dispose(),scene.remove(directionalLightHelper4)),config.showLightHelpers=!1}function initLights(){directionalLight1.position.set(0,2.5,3.9),directionalLight2.position.set(4,1,-4),directionalLight3.position.set(-4,1,-4),directionalLight4.position.set(0,-4,0),scene.add(directionalLight1),scene.add(directionalLight2),scene.add(directionalLight3),scene.add(directionalLight4)}function initInfiniteFloor(){const e=textureLoader.load("/assets/images/tiles.png");e.anisotrophy=2,e.minFilter=THREE.LinearFilter,e.wrapS=THREE.RepeatWrapping,e.wrapT=THREE.RepeatWrapping;const o=textureLoader.load("/assets/images/infiniteTilesAlphaMap.png");o.wrapS=THREE.RepeatWrapping,o.wrapT=THREE.RepeatWrapping,o.repeat.set(1,1),infiniteFloorMaterial=new THREE.MeshBasicMaterial({side:THREE.DoubleSide,transparent:!0,map:e,alphaMap:o,opacity:0}),infiniteFloorMaterial.onBeforeCompile=function(e){var o=e.vertexShader.replace("#include <uv_vertex>",["#include <uv_vertex>","vUvB = uvB;"].join("\n"));e.vertexShader="attribute vec2 uvB;\nvarying vec2 vUvB;\n"+o;var t=e.fragmentShader.replace("#include <map_fragment>",["vec4 texelColor = texture2D( map, vUvB );","texelColor = mapTexelToLinear( texelColor );","diffuseColor *= texelColor;"].join("\n"));e.fragmentShader="varying vec2 vUvB;\n"+t};const t=new THREE.PlaneBufferGeometry(config.infiniteFloorSize,config.infiniteFloorSize);t.rotateX(-Math.PI/2),t.translate(0,-2.01,0);var n=new Float32Array([0,config.infiniteFloorSize,config.infiniteFloorSize,config.infiniteFloorSize,0,0,config.infiniteFloorSize,0]);console.log(t),t.setAttribute("uvB",new THREE.BufferAttribute(n,2));const i=new THREE.Mesh(t,infiniteFloorMaterial);i.name="infiniteFloor",scene.add(i),group.add(i),objects.push(i)}function initFloor(){const e=textureLoader.load("/assets/images/tiles.png");e.anisotrophy=16,e.minFilter=THREE.NearestFilter,e.wrapS=THREE.RepeatWrapping,e.wrapT=THREE.RepeatWrapping,e.repeat=new THREE.Vector2(6,6);const o=new THREE.MeshBasicMaterial({color:16777215,map:e,side:THREE.DoubleSide}),t=new THREE.PlaneGeometry(6,6);t.rotateX(Math.PI/2),t.translate(0,-2,0);const n=new THREE.Mesh(t,o);scene.add(n),group.add(n),objects.push(n),initInfiniteFloor()}function onResize(){console.log("resizing"),camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight)}function onMouseMove(e){mouse.x=e.offsetX/renderer.domElement.scrollWidth*2-1,mouse.y=-e.offsetY/renderer.domElement.scrollHeight*2+1}function applyFadeToAllExcept(e){document.getElementById("canvasBg").classList.add("faded");new TWEEN.Tween(fadePlaneMesh.material).to({opacity:.3},300).delay(300).easing(TWEEN.Easing.Quadratic.InOut).start()}function removeFadeFromAll(){document.getElementById("canvasBg").classList.remove("faded");new TWEEN.Tween(fadePlaneMesh.material).to({opacity:0},500).easing(TWEEN.Easing.Quadratic.InOut).start()}function handleImgClicked(e){selectedObj=e,scene.attach(e),e.selected=!0,selectedObj.bringToFocus(camera,config.selectedDist,config.selectedScale),fadePlaneMesh.position.set(0,camera.position.y-(config.selectedDist+.01),camera.position.z-(config.selectedDist+.01)),fadePlaneMesh.quaternion.copy(camera.quaternion),applyFadeToAllExcept(selectedObj)}function putSelectedBack(){group.attach(selectedObj),selectedObj.putSelectedBack(400),removeFadeFromAll(),selectedObj=null}function handleClick(){if(!clickBusy)if(setTimeout((function(){clickBusy=!1}),200),clickBusy=!0,selectedObj)putSelectedBack();else if(clickables.length>0){const e=raycaster.intersectObjects(clickables);e.length>0&&handleImgClicked(e[0].object)}}function animate(){videoTexture&&videoTexture.update(),controls.update(clock.getDelta()),selectedObj&&animateSelectedObj()}function animateSelectedObj(){let e=clock.getElapsedTime();selectedObj.position.y+=.001*Math.sin(e)*Math.pow(config.selectedDist,1),selectedObj.rotation.x+=2e-4*Math.sin(1.2*e),selectedObj.rotation.y+=5e-4*Math.sin(.7*e),fadePlaneMesh.position.y+=.001*Math.sin(e)*Math.pow(config.selectedDist,1),fadePlaneMesh.rotation.x+=2e-4*Math.sin(1.2*e),fadePlaneMesh.rotation.y+=5e-4*Math.sin(.7*e)}function handleRaycast(){if(raycaster.setFromCamera(mouse,camera),!this.selectedObj&&clickables.length>0){const e=raycaster.intersectObjects(clickables);if(e.length>0){renderer.domElement.style.cursor="pointer",controls.mouseBusy=!0;for(let o of clickables)e[0].object!=o||o.tweening||o.selected?(o.hovered=!1,!o.up||o.tweening||o.selected||o.putBack()):(o.hovered=!0,o.liftUp())}else{controls.mouseBusy=!1,renderer.domElement.style.cursor="grab";for(let e of clickables)e.hovered=!1,!e.up||e.tweening||e.selected||e.putBack()}}}function showInfiniteFloor(){new TWEEN.Tween(infiniteFloorMaterial).to({opacity:.2},200).easing(TWEEN.Easing.Quadratic.InOut).start()}function hideInfiniteFloor(){new TWEEN.Tween(infiniteFloorMaterial).to({opacity:0},200).easing(TWEEN.Easing.Quadratic.InOut).start()}function render(){animate(),renderer.render(scene,camera),TWEEN.update(),requestAnimationFrame(render),hasHover&&handleRaycast()}function handleTouchStart(){giveUsASpin()}function addEvents(){window.addEventListener("resize",onResize,!1),hasHover||!config.restrictMobile?(renderer.domElement.addEventListener("mousemove",onMouseMove,!1),renderer.domElement.addEventListener("mousedown",handleClick,!1)):renderer.domElement.addEventListener("touchstart",handleTouchStart,!1);let e=document.getElementById("minimap");e.addEventListener("mouseenter",(function(){showInfiniteFloor()})),e.addEventListener("mouseleave",(function(){hideInfiniteFloor()}))}function configLoadingManager(){THREE.DefaultLoadingManager.onStart=function(e,o,t){console.log("Started loading file: "+e+".\nLoaded "+o+" of "+t+" files.")},THREE.DefaultLoadingManager.onLoad=function(){console.log("Loading Complete!"),document.getElementById("threeCanvas").style.opacity=1;let e=document.getElementById("loader");e.style.opacity=0,spinIn(),setTimeout((function(){e.remove()}),2e3)},THREE.DefaultLoadingManager.onProgress=function(e,o,t){console.log("Loading file: "+e+".\nLoaded "+o+" of "+t+" files.")},THREE.DefaultLoadingManager.onError=function(e){console.log("There was an error loading "+e)}}function addObj(e,o){objLoader.load(e,(function(e){e.traverse((function(e){e instanceof THREE.Mesh&&o(e)}))}),(function(e){}),(function(e){console.log(e)}))}function addFbx(e,o){fbxLoader.load(e,(function(e){e.traverse((function(e){e instanceof THREE.Mesh&&o(e)}))}),(function(e){}),(function(e){console.log(e)}))}function addImage(e,o){try{const t=new THREE.MeshBasicMaterial({alphaTest:.5}),n=textureLoader.load(e);n.anisotrophy=4,t.map=n;const i=new THREE.MeshBasicMaterial({color:0,transparent:!0,opacity:0,depthWrite:!1}),a=[i,i,i,i,t,t],r=new Image;r.onload=()=>{const e=r.height/r.width,t=new THREE.BoxGeometry(1,1*e,1e-4),n=new ImageMesh(t,a);o(n)},r.src=e}catch(e){console.log(e)}}function addVideo(e,o){try{const t=document.createElement("video"),n=document.createElement("source");n.setAttribute("src",e),t.appendChild(n),t.classList.add("3dVideoTexture"),t.setAttribute("autoplay",""),t.autoplay=!0,t.setAttribute("muted",""),t.muted=!0,t.setAttribute("loop",""),t.loop=!0;document.getElementById("videoTextureContainer").appendChild(t);const i=new THREE.VideoTexture(t),a=new THREE.MeshBasicMaterial({transparent:!1});a.map=i;const r=new THREE.MeshBasicMaterial({color:0,transparent:!0,opacity:0}),l=[r,r,r,r,a,a];t.addEventListener("loadedmetadata",(function(e){const n=t.videoHeight/t.videoWidth;console.log(n);const i=new THREE.BoxGeometry(1,1*n,1e-4),a=new ImageMesh(i,l);o(a)}))}catch(e){console.log(e)}}function giveUsASpin(){const e=new TWEEN.Tween(controls).to({autoSpeed:3*config.mobileTapRotateAmount},100).easing(TWEEN.Easing.Quadratic.In).onComplete((()=>{o.start()})),o=new TWEEN.Tween(controls).to({autoSpeed:.1},2e3*config.mobileTapRotateAmount).easing(TWEEN.Easing.Quadratic.Out).onComplete((()=>{}));e.start()}function spinIn(){const e=new TWEEN.Tween(controls).to({autoSpeed:15},100).easing(TWEEN.Easing.Quadratic.In).onComplete((()=>{o.start()})),o=new TWEEN.Tween(controls).to({autoSpeed:.1},2e3).easing(TWEEN.Easing.Quadratic.Out).onComplete((()=>{}));e.start();new TWEEN.Tween(group.scale).to({x:1,y:1,z:1},2e3).easing(TWEEN.Easing.Quadratic.Out).onComplete((()=>{})).start(),e.start()}function handleBlobColourChange(){for(let e of blobs)blobMaterial=fresnelMaterial(config.blobFresnelColour,config.blobFresnelAmount1,config.blobFresnelAmount2,config.blobFresnelAmount3,config.blobFresnelAmount4,config.blobFresnelAmount5,config.blobFresnelAmount6,config.blobFresnelAmount7,config.blobFresnelAmount8),e.material=blobMaterial}function handleUpdateCameraMatrix(){camera.updateProjectionMatrix()}function handleUpdateCameraDist(){camera.position.z=Math.sqrt(config.cameraDist*config.cameraDist/2),camera.position.y=Math.sqrt(config.cameraDist*config.cameraDist/2),camera.lookAt(0,0,0),handleUpdateCameraMatrix()}function handleSelectedDistUpdate(){selectedObj&&(selectedObj.position.y=camera.position.y-config.selectedDist,selectedObj.position.z=camera.position.z-config.selectedDist,fadePlaneMesh.position.set(0,camera.position.y-1.01*config.selectedDist,camera.position.z-1.01*config.selectedDist),camera.near=Math.pow(.999*config.selectedDist,2))}function handleSelectedScaleUpdate(){selectedObj&&selectedObj.scale.set(config.selectedScale,config.selectedScale,config.selectedScale)}function handleToggleLightHelpers(){config.showLightHelpers?initLightHelpers():disposeLightHelpers()}function handleControlsChange(){console.log(config.restrictMobile),controls=new THREE.ObjectControls(group,renderer.domElement,hasHover,config.restrictMobile)}function initGUI(){controlsGUI.add(controls,"autoSpeed",-1,1,.05).name("Auto Rotate Speed"),controlsGUI.add(controls,"rotationSpeed",0,.1,.01).name("Drag Rotate Speed"),controlsGUI.add(config,"mobileTapRotateAmount",0,3,.1).name("Mobile Tap Speed"),controlsGUI.add(config,"restrictMobile").name("Restrict Mobile Controls").onChange(handleControlsChange),viewContraintsGUI=controlsGUI.addFolder("View Angle Contraints"),viewContraintsGUI.add(controls.maxRotationAngles.x,"from",Math.PI/4,Math.PI,.01).name("Min Angle"),viewContraintsGUI.add(controls.maxRotationAngles.x,"to",0,Math.PI,.01).name("Max Angle"),controlsGUI.add(config,"simulateMobileTap").onChange(giveUsASpin).name("Simulate Mobile Tap"),colourGUI.addColor(config,"blobFresnelColour").onChange(handleBlobColourChange).name("Fresnel Colour"),colourGUI.add(config,"blobFresnelAmount1",0,2,.01).onChange(handleBlobColourChange).name("Fresel Mod 1"),colourGUI.add(config,"blobFresnelAmount2",0,2,.01).onChange(handleBlobColourChange).name("Fresel Mod 2"),colourGUI.add(config,"blobFresnelAmount3",0,2,.01).onChange(handleBlobColourChange).name("Fresel Mod 3"),colourGUI.add(config,"blobFresnelAmount4",0,2,.01).onChange(handleBlobColourChange).name("Fresel Mod 4"),colourGUI.add(config,"blobFresnelAmount5",0,2,.01).onChange(handleBlobColourChange).name("Fresel Mod 5"),colourGUI.add(config,"blobFresnelAmount6",0,2,.01).onChange(handleBlobColourChange).name("Fresel Mod 6"),colourGUI.add(config,"blobFresnelAmount7",0,2,.01).onChange(handleBlobColourChange).name("Fresel Mod 7"),colourGUI.add(config,"blobFresnelAmount8",0,2,.01).onChange(handleBlobColourChange).name("Fresel Mod 8"),cameraGUI.add(camera,"fov",0,150,1).onChange(handleUpdateCameraMatrix).name("FOV"),cameraGUI.add(config,"cameraDist",1,20,.1).onChange(handleUpdateCameraDist).name("Camera Dist"),cameraGUI.add(config,"selectedDist",0,.8,.001).onChange(handleSelectedDistUpdate).name("Selected Obj Dist"),cameraGUI.add(config,"selectedScale",0,2,.001).onChange(handleSelectedScaleUpdate).name("Selected Obj Scale"),lightsGUI.add(config,"showLightHelpers").onChange(handleToggleLightHelpers).name("Show Light Helpers"),directionalLight1GUI=lightsGUI.addFolder("Directional Light 1"),directionalLight1GUI.add(directionalLight1,"intensity",0,1,.1).name("Intensity"),directionalLight1GUI.add(directionalLight1.position,"x",-3,3,.1).name("X position"),directionalLight1GUI.add(directionalLight1.position,"y",0,8,.1).name("Y position"),directionalLight1GUI.add(directionalLight1.position,"z",0,10,.1).name("Z position"),directionalLight2GUI=lightsGUI.addFolder("Directional Light 2"),directionalLight2GUI.add(directionalLight2,"intensity",0,1,.1).name("Intensity"),directionalLight2GUI.add(directionalLight2.position,"x",0,8,.1).name("X position"),directionalLight2GUI.add(directionalLight2.position,"y",0,8,.1).name("Y position"),directionalLight2GUI.add(directionalLight2.position,"z",-10,0,.1).name("Z position"),directionalLight3GUI=lightsGUI.addFolder("Directional Light 3"),directionalLight3GUI.add(directionalLight3,"intensity",0,1,.1),directionalLight3GUI.add(directionalLight3.position,"x",-8,0,.1),directionalLight3GUI.add(directionalLight3.position,"y",0,8,.1),directionalLight3GUI.add(directionalLight3.position,"z",-10,0,.1),directionalLight4GUI=lightsGUI.addFolder("Directional Light 4"),directionalLight4GUI.add(directionalLight4,"intensity",0,1,.1),directionalLight4GUI.add(directionalLight4.position,"x",-8,0,.1),directionalLight4GUI.add(directionalLight4.position,"y",0,8,.1),directionalLight4GUI.add(directionalLight4.position,"z",-10,0,.1)}function initRoomFromConfig(){for(let e of roomConfig.images)addImage(e.path,(function(o){o.scale.set(e.scale,e.scale,e.scale),o.position.set(e.position.x,e.position.y,e.position.z),o.rotation.set(e.rotation.x,e.rotation.y,e.rotation.z),o.position0.copy(o.position),o.rotation0.copy(o.rotation),o.quaternion0.copy(o.quaternion),o.scale0.copy(o.scale),group.add(o),objects.push(o),clickables.push(o)}));for(let e of roomConfig.blobs)addFbx(e.path,(function(o){o.material=blobMaterial,o.scale.set(e.scale,e.scale,e.scale),o.position.set(e.position.x,e.position.y,e.position.z),o.rotation.set(e.rotation.x,e.rotation.y,e.rotation.z),group.add(o),o.name="blob",objects.push(o),blobs.push(o)}));if(roomConfig.videos)for(let e of roomConfig.videos)console.log(e),addVideo(e.path,(function(o){o.scale.set(e.scale,e.scale,e.scale),o.position.set(e.position.x,e.position.y,e.position.z),o.rotation.set(e.rotation.x,e.rotation.y,e.rotation.z),o.position0.copy(o.position),o.rotation0.copy(o.rotation),o.quaternion0.copy(o.quaternion),o.scale0.copy(o.scale),group.add(o),objects.push(o),clickables.push(o),videos.push(o)}))}function initGroup(){group.scale.set(.05,.05,.05)}function initFadePlaneMesh(){const e=new THREE.PlaneGeometry(10,10),o=new THREE.MeshBasicMaterial({color:16777215,opacity:0,transparent:!0});fadePlaneMesh=new THREE.Mesh(e,o),fadePlaneMesh.position.set(0,camera.position.y-(config.selectedDist+.001),camera.position.z-(config.selectedDist+.001)),fadePlaneMesh.quaternion.copy(camera.quaternion),scene.add(fadePlaneMesh)}function init(){initGroup(),initLights(),initFloor(),initRoomFromConfig(),addEvents(),initGUI(),configLoadingManager(),render(),initFadePlaneMesh()}init();