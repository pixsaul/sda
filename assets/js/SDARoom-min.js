const config={simulateMobileTap:!1,mobileTapRotateAmount:1,blobFresnelColour:16727846,blobFresnelAmount1:.1,blobFresnelAmount2:1.18,blobFresnelAmount3:.32,blobFresnelAmount4:.28,blobFresnelAmount5:0,blobFresnelAmount6:0,blobFresnelAmount7:0,blobFresnelAmount8:0,initialFov:100,cameraDist:6.1,selectedDist:.5,selectedScale:.63,showLightHelpers:!1,restrictMobile:!1,infiniteFloorSize:100},hasHover=window.matchMedia("(hover: hover)").matches,renderer=new THREE.WebGLRenderer({alpha:!0,canvas:document.getElementById("threeCanvas"),antialias:!0,logarithmicDepthBuffer:!1}),canvas=renderer.domElement,cWidth=canvas.clientWidth,cHeight=canvas.clientHeight;renderer.setPixelRatio(1*window.devicePixelRatio),canvas.width===cWidth&&canvas.height===cHeight||renderer.setSize(cWidth,cHeight,!1),renderer.setClearColor(16777215,0);const camera=new THREE.PerspectiveCamera(config.initialFov,cWidth/cHeight,.001,2e4);camera.position.z=Math.sqrt(config.cameraDist*config.cameraDist/2),camera.position.y=Math.sqrt(config.cameraDist*config.cameraDist/2),camera.lookAt(0,0,0);const group=new THREE.Object3D,objects=[],clickables=[],blobs=[],scene=new THREE.Scene;scene.add(group);let controls=new THREE.ObjectControls(group,renderer.domElement,hasHover,config.restrictMobile);const directionalLight1=new THREE.DirectionalLight(16777215,0),directionalLight2=new THREE.DirectionalLight(16777215,.3),directionalLight3=new THREE.DirectionalLight(16777215,.4),directionalLight4=new THREE.DirectionalLight(16777215,.5);var directionalLightHelper1,directionalLightHelper2,directionalLightHelper3,directionalLightHelper4,blobMaterial=fresnelMaterial(config.blobFresnelColour,config.blobFresnelAmount1,config.blobFresnelAmount2,config.blobFresnelAmount3,config.blobFresnelAmount4,config.blobFresnelAmount5,config.blobFresnelAmount6,config.blobFresnelAmount7,config.blobFresnelAmount8);const hemiLight=new THREE.HemisphereLight(16777215,0,.8),objLoader=new THREE.OBJLoader,fbxLoader=new THREE.FBXLoader,textureLoader=new THREE.TextureLoader;var videoTexture,videoMaterial,videoObj,videos=[];const mouse=new THREE.Vector2(-100,-100),raycaster=new THREE.Raycaster;var selectedObj,hoverObj,hoverObjPosition0=new THREE.Vector3;const gui=new dat.GUI({autoPlace:!0}),cameraGUI=gui.addFolder("Camera"),controlsGUI=gui.addFolder("Controls"),colourGUI=gui.addFolder("Colour"),lightsGUI=gui.addFolder("Lights");let infiniteFloorMaterial;var clickBusy=!1;const clock=new THREE.Clock;let fadePlaneMesh;function initLightHelpers(){directionalLightHelper1=new THREE.DirectionalLightHelper(directionalLight1,1,"purple"),directionalLightHelper2=new THREE.DirectionalLightHelper(directionalLight2,1,"blue"),directionalLightHelper3=new THREE.DirectionalLightHelper(directionalLight3,1,"red"),directionalLightHelper4=new THREE.DirectionalLightHelper(directionalLight4,1,"green"),scene.add(directionalLightHelper1),scene.add(directionalLightHelper2),scene.add(directionalLightHelper3),scene.add(directionalLightHelper4),config.showLightHelpers=!0}function disposeLightHelpers(){directionalLightHelper1&&(directionalLightHelper1.dispose(),scene.remove(directionalLightHelper1)),directionalLightHelper2&&(directionalLightHelper2.dispose(),scene.remove(directionalLightHelper2)),directionalLightHelper3&&(directionalLightHelper3.dispose(),scene.remove(directionalLightHelper3)),directionalLightHelper4&&(directionalLightHelper4.dispose(),scene.remove(directionalLightHelper4)),config.showLightHelpers=!1}function initLights(){directionalLight1.position.set(0,2.5,3.9),directionalLight2.position.set(4,1,-4),directionalLight3.position.set(-4,1,-4),directionalLight4.position.set(0,-4,0),scene.add(directionalLight1),scene.add(directionalLight2),scene.add(directionalLight3),scene.add(directionalLight4)}function initInfiniteFloor(){const e=textureLoader.load("/assets/images/tiles.png");e.anisotrophy=2,e.minFilter=THREE.LinearFilter,e.wrapS=THREE.RepeatWrapping,e.wrapT=THREE.RepeatWrapping;const t=textureLoader.load("/assets/images/infiniteTilesAlphaMap.png");t.wrapS=THREE.RepeatWrapping,t.wrapT=THREE.RepeatWrapping,t.repeat.set(1,1),infiniteFloorMaterial=new THREE.MeshBasicMaterial({side:THREE.DoubleSide,transparent:!0,map:e,alphaMap:t,opacity:0}),infiniteFloorMaterial.onBeforeCompile=function(e){var t=e.vertexShader.replace("#include <uv_vertex>",["#include <uv_vertex>","vUvB = uvB;"].join("\n"));e.vertexShader="attribute vec2 uvB;\nvarying vec2 vUvB;\n"+t;var o=e.fragmentShader.replace("#include <map_fragment>",["vec4 texelColor = texture2D( map, vUvB );","texelColor = mapTexelToLinear( texelColor );","diffuseColor *= texelColor;"].join("\n"));e.fragmentShader="varying vec2 vUvB;\n"+o};const o=new THREE.PlaneBufferGeometry(config.infiniteFloorSize,config.infiniteFloorSize);o.rotateX(-Math.PI/2),o.translate(0,-2.01,0);var i=new Float32Array([0,config.infiniteFloorSize,config.infiniteFloorSize,config.infiniteFloorSize,0,0,config.infiniteFloorSize,0]);console.log(o),o.setAttribute("uvB",new THREE.BufferAttribute(i,2));const n=new THREE.Mesh(o,infiniteFloorMaterial);n.name="infiniteFloor",scene.add(n),group.add(n),objects.push(n)}function initFloor(){const e=textureLoader.load("/assets/images/tiles.png");e.anisotrophy=16,e.minFilter=THREE.NearestFilter,e.wrapS=THREE.RepeatWrapping,e.wrapT=THREE.RepeatWrapping,e.repeat=new THREE.Vector2(6,6);const t=new THREE.MeshBasicMaterial({color:16777215,map:e,side:THREE.DoubleSide}),o=new THREE.PlaneGeometry(6,6);o.rotateX(Math.PI/2),o.translate(0,-2,0);const i=new THREE.Mesh(o,t);scene.add(i),group.add(i),objects.push(i),initInfiniteFloor()}function onResize(){console.log("resizing");const e=canvas.clientWidth,t=canvas.clientHeight;canvas.width===e&&canvas.height===t||renderer.setSize(e,t,!1),camera.aspect=e/t,camera.updateProjectionMatrix()}function onMouseMove(e){mouse.x=e.offsetX/renderer.domElement.scrollWidth*2-1,mouse.y=-e.offsetY/renderer.domElement.scrollHeight*2+1}function applyFadeToAllExcept(e){document.getElementById("canvasBg").classList.add("faded");new TWEEN.Tween(fadePlaneMesh.material).to({opacity:.3},300).delay(300).easing(TWEEN.Easing.Quadratic.InOut).start()}function removeFadeFromAll(){document.getElementById("canvasBg").classList.remove("faded");new TWEEN.Tween(fadePlaneMesh.material).to({opacity:0},500).easing(TWEEN.Easing.Quadratic.InOut).start()}function handleImgClicked(e){selectedObj=e,scene.attach(e),e.selected=!0,selectedObj.bringToFocus(camera,config.selectedDist,config.selectedScale),fadePlaneMesh.position.set(0,camera.position.y-(config.selectedDist+.01),camera.position.z-(config.selectedDist+.01)),fadePlaneMesh.quaternion.copy(camera.quaternion),applyFadeToAllExcept(selectedObj)}function putSelectedBack(){group.attach(selectedObj),selectedObj.putSelectedBack(800),removeFadeFromAll(),selectedObj=null}function handleClick(){if(!clickBusy)if(setTimeout((function(){clickBusy=!1}),200),clickBusy=!0,selectedObj)putSelectedBack();else if(clickables.length>0){raycaster.setFromCamera(mouse,camera);const e=raycaster.intersectObjects(clickables);console.log(e),e.length>0&&handleImgClicked(e[0].object)}}function animate(){videoTexture&&videoTexture.update(),controls.update(clock.getDelta()),selectedObj&&animateSelectedObj()}function animateSelectedObj(){let e=clock.getElapsedTime();selectedObj.position.y+=.001*Math.sin(e)*Math.pow(config.selectedDist,1),selectedObj.rotation.x+=2e-4*Math.sin(1.2*e),selectedObj.rotation.y+=5e-4*Math.sin(.7*e)}function handleRaycast(){if(raycaster.setFromCamera(mouse,camera),!this.selectedObj&&clickables.length>0){const e=raycaster.intersectObjects(clickables);if(e.length>0){renderer.domElement.style.cursor="pointer",controls.mouseBusy=!0;for(let t of clickables)e[0].object!=t||t.tweening||t.selected?(t.hovered=!1,!t.up||t.tweening||t.selected||t.putBack()):(t.hovered=!0,t.liftUp())}else{controls.mouseBusy=!1,renderer.domElement.style.cursor="grab";for(let e of clickables)e.hovered=!1,!e.up||e.tweening||e.selected||e.putBack()}}}function showInfiniteFloor(){new TWEEN.Tween(infiniteFloorMaterial).to({opacity:.2},200).easing(TWEEN.Easing.Quadratic.InOut).start()}function hideInfiniteFloor(){new TWEEN.Tween(infiniteFloorMaterial).to({opacity:0},200).easing(TWEEN.Easing.Quadratic.InOut).start()}function render(){animate(),renderer.render(scene,camera),TWEEN.update(),requestAnimationFrame(render),hasHover&&handleRaycast()}function handleTouchStart(e){if(config.restrictMobile)giveUsASpin();else{console.log(e.touches[0]);var t=renderer.domElement.getBoundingClientRect();mouse.x=(e.touches[0].pageX-t.left)/renderer.domElement.scrollWidth*2-1,mouse.y=-(e.touches[0].pageY-t.top)/renderer.domElement.scrollHeight*2+1,console.log(mouse),handleClick()}}function addEvents(){window.addEventListener("resize",onResize,!1),hasHover?(renderer.domElement.addEventListener("mousemove",onMouseMove,!1),renderer.domElement.addEventListener("mousedown",handleClick,!1)):renderer.domElement.addEventListener("touchstart",handleTouchStart,!1);let e=document.getElementById("minimap");e.addEventListener("mouseenter",(function(){showInfiniteFloor()})),e.addEventListener("mouseleave",(function(){hideInfiniteFloor()}))}function configLoadingManager(){THREE.DefaultLoadingManager.onStart=function(e,t,o){console.log("Started loading file: "+e+".\nLoaded "+t+" of "+o+" files.")},THREE.DefaultLoadingManager.onLoad=function(){console.log("Loading Complete!"),document.getElementById("threeCanvas").style.opacity=1;let e=document.getElementById("loader");e.style.opacity=0,spinIn(),setTimeout((function(){e.remove()}),2e3)},THREE.DefaultLoadingManager.onProgress=function(e,t,o){console.log("Loading file: "+e+".\nLoaded "+t+" of "+o+" files.")},THREE.DefaultLoadingManager.onError=function(e){console.log("There was an error loading "+e)}}function addObj(e,t){objLoader.load(e,(function(e){e.traverse((function(e){e instanceof THREE.Mesh&&t(e)}))}),(function(e){}),(function(e){console.log(e)}))}function addFbx(e,t){fbxLoader.load(e,(function(e){e.traverse((function(e){e instanceof THREE.Mesh&&t(e)}))}),(function(e){}),(function(e){console.log(e)}))}function addImage(e,t){try{const o=new THREE.MeshBasicMaterial({alphaTest:.5}),i=textureLoader.load(e);i.anisotrophy=8,o.map=i;const n=new THREE.MeshBasicMaterial({color:0,transparent:!0,opacity:0,depthWrite:!1}),a=[n,n,n,n,o,o],r=new Image;r.onload=()=>{const e=r.height/r.width,o=new THREE.BoxGeometry(1,1*e,1e-4),i=new ImageMesh(o,a,e);t(i)},r.src=e}catch(e){console.log(e)}}function addVideo(e,t){try{const o=document.createElement("video"),i=document.createElement("source");i.setAttribute("src",e),o.appendChild(i),o.classList.add("3dVideoTexture"),o.setAttribute("autoplay",""),o.autoplay=!0,o.setAttribute("muted",""),o.muted=!0,o.setAttribute("loop",""),o.loop=!0;document.getElementById("videoTextureContainer").appendChild(o);const n=new THREE.VideoTexture(o),a=new THREE.MeshBasicMaterial({transparent:!1});a.map=n;const r=new THREE.MeshBasicMaterial({color:0,transparent:!0,opacity:0}),l=[r,r,r,r,a,a];o.addEventListener("loadedmetadata",(function(e){const i=o.videoHeight/o.videoWidth;console.log(i);const n=new THREE.BoxGeometry(1,1*i,1e-4),a=new ImageMesh(n,l,i);t(a),o.play()}))}catch(e){console.log(e)}}function giveUsASpin(){const e=new TWEEN.Tween(controls).to({autoSpeed:3*config.mobileTapRotateAmount},100).easing(TWEEN.Easing.Quadratic.In).onComplete((()=>{t.start()})),t=new TWEEN.Tween(controls).to({autoSpeed:.1},2e3*config.mobileTapRotateAmount).easing(TWEEN.Easing.Quadratic.Out).onComplete((()=>{}));e.start()}function spinIn(){const e=new TWEEN.Tween(controls).to({autoSpeed:15},100).easing(TWEEN.Easing.Quadratic.In).onComplete((()=>{t.start()})),t=new TWEEN.Tween(controls).to({autoSpeed:.1},2e3).easing(TWEEN.Easing.Quadratic.Out).onComplete((()=>{}));e.start();new TWEEN.Tween(group.scale).to({x:1,y:1,z:1},2e3).easing(TWEEN.Easing.Quadratic.Out).onComplete((()=>{})).start(),e.start()}function handleBlobColourChange(){for(let e of blobs)blobMaterial=fresnelMaterial(config.blobFresnelColour,config.blobFresnelAmount1,config.blobFresnelAmount2,config.blobFresnelAmount3,config.blobFresnelAmount4,config.blobFresnelAmount5,config.blobFresnelAmount6,config.blobFresnelAmount7,config.blobFresnelAmount8),e.material=blobMaterial}function handleUpdateCameraMatrix(){camera.updateProjectionMatrix()}function handleUpdateCameraDist(){camera.position.z=Math.sqrt(config.cameraDist*config.cameraDist/2),camera.position.y=Math.sqrt(config.cameraDist*config.cameraDist/2),camera.lookAt(0,0,0),handleUpdateCameraMatrix()}function handleSelectedDistUpdate(){selectedObj&&(selectedObj.position.y=camera.position.y-config.selectedDist,selectedObj.position.z=camera.position.z-config.selectedDist,fadePlaneMesh.position.set(0,camera.position.y-1.01*config.selectedDist,camera.position.z-1.01*config.selectedDist),camera.near=Math.pow(.999*config.selectedDist,2))}function handleSelectedScaleUpdate(){selectedObj&&selectedObj.scale.set(config.selectedScale,config.selectedScale,config.selectedScale)}function handleToggleLightHelpers(){config.showLightHelpers?initLightHelpers():disposeLightHelpers()}function handleControlsChange(){console.log(config.restrictMobile),controls=new THREE.ObjectControls(group,renderer.domElement,hasHover,config.restrictMobile)}function initGUI(){controlsGUI.add(controls,"autoSpeed",-1,1,.05).name("Auto Rotate Speed"),controlsGUI.add(controls,"rotationSpeed",0,.1,.01).name("Drag Rotate Speed"),controlsGUI.add(config,"mobileTapRotateAmount",0,3,.1).name("Mobile Tap Speed"),controlsGUI.add(config,"restrictMobile").name("Restrict Mobile Controls").onChange(handleControlsChange),viewContraintsGUI=controlsGUI.addFolder("View Angle Contraints"),viewContraintsGUI.add(controls.maxRotationAngles.x,"from",Math.PI/4,Math.PI,.01).name("Min Angle"),viewContraintsGUI.add(controls.maxRotationAngles.x,"to",0,Math.PI,.01).name("Max Angle"),controlsGUI.add(config,"simulateMobileTap").onChange(giveUsASpin).name("Simulate Mobile Tap"),cameraGUI.add(camera,"fov",0,150,1).onChange(handleUpdateCameraMatrix).name("FOV"),cameraGUI.add(config,"cameraDist",1,20,.1).onChange(handleUpdateCameraDist).name("Camera Dist"),cameraGUI.add(config,"selectedDist",0,.8,.001).onChange(handleSelectedDistUpdate).name("Selected Obj Dist"),cameraGUI.add(config,"selectedScale",0,2,.001).onChange(handleSelectedScaleUpdate).name("Selected Obj Scale"),lightsGUI.add(config,"showLightHelpers").onChange(handleToggleLightHelpers).name("Show Light Helpers"),directionalLight1GUI=lightsGUI.addFolder("Directional Light 1"),directionalLight1GUI.add(directionalLight1,"intensity",0,1,.1).name("Intensity"),directionalLight1GUI.add(directionalLight1.position,"x",-3,3,.1).name("X position"),directionalLight1GUI.add(directionalLight1.position,"y",0,8,.1).name("Y position"),directionalLight1GUI.add(directionalLight1.position,"z",0,10,.1).name("Z position"),directionalLight2GUI=lightsGUI.addFolder("Directional Light 2"),directionalLight2GUI.add(directionalLight2,"intensity",0,1,.1).name("Intensity"),directionalLight2GUI.add(directionalLight2.position,"x",0,8,.1).name("X position"),directionalLight2GUI.add(directionalLight2.position,"y",0,8,.1).name("Y position"),directionalLight2GUI.add(directionalLight2.position,"z",-10,0,.1).name("Z position"),directionalLight3GUI=lightsGUI.addFolder("Directional Light 3"),directionalLight3GUI.add(directionalLight3,"intensity",0,1,.1),directionalLight3GUI.add(directionalLight3.position,"x",-8,0,.1),directionalLight3GUI.add(directionalLight3.position,"y",0,8,.1),directionalLight3GUI.add(directionalLight3.position,"z",-10,0,.1),directionalLight4GUI=lightsGUI.addFolder("Directional Light 4"),directionalLight4GUI.add(directionalLight4,"intensity",0,1,.1),directionalLight4GUI.add(directionalLight4.position,"x",-8,0,.1),directionalLight4GUI.add(directionalLight4.position,"y",0,8,.1),directionalLight4GUI.add(directionalLight4.position,"z",-10,0,.1)}function initRoomFromConfig(){for(let e of roomConfig.images)addImage(e.path,(function(t){t.scale.set(e.scale,e.scale,e.scale),t.position.set(e.position.x,e.position.y,e.position.z),t.rotation.set(e.rotation.x,e.rotation.y,e.rotation.z),t.position0.copy(t.position),t.rotation0.copy(t.rotation),t.quaternion0.copy(t.quaternion),t.scale0.copy(t.scale),group.add(t),objects.push(t),clickables.push(t)}));for(let e of roomConfig.blobs)addFbx(e.path,(function(t){let o=new THREE.ShaderMaterial({uniforms:{treshold:{type:"f",value:1},fresnelFalloff:{type:"f",value:1},fresnelIntensity:{type:"f",value:1.5},colorInside:{type:"c3",value:new THREE.Color(16727070)},colorFresnel:{type:"c3",value:new THREE.Color(15970731)}},vertexShader:"\n      varying vec3 vPositionW;\n      varying vec3 vNormalW;\n\n      void main() {\n\n      vPositionW = vec3( vec4( position, 1.0 ) * modelViewMatrix );\n      vNormalW = normalize( mat3( modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz ) * normal );\n      gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n    }",fragmentShader:"\n      varying vec3 vPositionW;\n      varying vec3 vNormalW;\n      uniform vec3 colorInside;\n      uniform vec3 colorFresnel;\n      uniform float fresnelFalloff;\n      uniform float fresnelIntensity;\n      uniform float treshold;\n\n      void main() {\n        vec3 color = vec3(1., 1., 1.);\n        vec3 viewDirectionW = normalize(cameraPosition - vPositionW);\n        float fresnelTerm = dot(viewDirectionW, vNormalW);\n        fresnelTerm = clamp(1.0 - fresnelTerm, 0., treshold);\n        gl_FragColor = vec4( mix(colorInside,colorFresnel*fresnelIntensity,pow(fresnelTerm,fresnelFalloff)), 1.);\n      }\n    "});colourGUI.add(o.uniforms.fresnelFalloff,"value",0,2).name("fresnelFalloff"),colourGUI.add(o.uniforms.fresnelIntensity,"value",0,2).name("fresnelIntensity"),t.material=o,t.scale.set(e.scale,e.scale,e.scale),t.position.set(e.position.x,e.position.y,e.position.z),t.rotation.set(e.rotation.x,e.rotation.y,e.rotation.z),group.add(t),t.name="blob",objects.push(t),blobs.push(t)}));if(roomConfig.videos)for(let e of roomConfig.videos)console.log(e),addVideo(e.path,(function(t){t.scale.set(e.scale,e.scale,e.scale),t.position.set(e.position.x,e.position.y,e.position.z),t.rotation.set(e.rotation.x,e.rotation.y,e.rotation.z),t.position0.copy(t.position),t.rotation0.copy(t.rotation),t.quaternion0.copy(t.quaternion),t.scale0.copy(t.scale),group.add(t),objects.push(t),clickables.push(t),videos.push(t)}))}function initGroup(){group.scale.set(.05,.05,.05)}function initFadePlaneMesh(){const e=new THREE.PlaneGeometry(10,10),t=new THREE.MeshBasicMaterial({color:16777215,opacity:0,transparent:!0,depthWrite:!1});fadePlaneMesh=new THREE.Mesh(e,t),fadePlaneMesh.renderOrder=0,fadePlaneMesh.position.set(0,camera.position.y-config.selectedDist,camera.position.z-config.selectedDist),fadePlaneMesh.quaternion.copy(camera.quaternion),scene.add(fadePlaneMesh)}function init(){initGroup(),initLights(),initFloor(),initRoomFromConfig(),addEvents(),initGUI(),configLoadingManager(),render(),initFadePlaneMesh()}init();